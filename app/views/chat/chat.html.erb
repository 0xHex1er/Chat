<%= javascript_include_tag "jquery.js" %>
<%= javascript_include_tag "bootstrap.js" %>
<%= javascript_include_tag "socketcluster.js" %>
<%= stylesheet_link_tag "bootstrap.css" %>

<style>
 .show_msg{
   min-height: 400px;
   max-height: 400px;
   border: gainsboro thin solid;
   overflow-y: scroll;
 }

 .right-msg {
   float: right;
   border: gainsboro thin solid;
   line-height: 30px;
   margin: 5px;
   padding: 5px;
 }

 .left-msg {
   float: left;
   border: gainsboro thin solid;
   line-height: 30px;
   margin: 5px;
   padding: 5px;
 }

 .layout-loading {
   vertical-align: middle;
   margin: 0 auto;
   text-align: center;
   display: none;
 }
 .loading-img {
   margin: 0px auto;
 }

 #load_old_message {
   margin: 0px auto;
   text-align: center;
 }
 #load_old_message:hover {
   cursor: pointer;
   text-decoration: none;
 }

</style>

<div class="container">
  <h1> [ คุณ <a id="user"><%= @user.name %></a> : คุยกับร้าน <a id="store"><%= @store.name %> </a>] </h1>
  <label for="txt_room_id"> Room ID : </label>
  <input type="text" id="txt_room_id" name="txt_room_id" value="" style="width: 445px;">
  <hr>
  <div class="row" style="margin-bottom: 5px;">
    <div id="show_msg" class="show_msg col-xs-12">
      <div class="layout-loading">
        <%= image_tag("loader.gif", class: "loading-img") %>
      </div>

    </div>
  </div>
  <div class="row">
    <input type="text" id="txt_msg" class="col-xs-9">
    <input type="button" id="btn_send" value=" Send Message " class="col-xs-3">
  </div>
</div>



<script>
  var global_page = 0;
  var global_store = "";
  var global_user = "";
  var global_receive_new_message = 0;
  var global_offset = 0;

  var socket = socketCluster.connect({
    host:'localhost',
    port: 3333
  });

  function set_link_load_old_message() {
    var per_page = 3;
    var tmp_new_page = parseInt(global_receive_new_message/per_page);
    var tmp_new_offset = parseInt(global_receive_new_message%per_page);

    // ดึงค่า Page ปัจจุบันจาก ปุ่มโหลดข้อความเก่า
    global_page = parseInt($("#load_old_message").attr("role"));

    console.log('========== set link load old message ==========');
    console.log('global_receive / perpage : ' + global_receive_new_message + '/' + per_page + ' = ' + tmp_new_page);
    console.log('global_receive % perpage : ' + global_receive_new_message + '%' + per_page + ' = ' + tmp_new_offset);

    //1. ตรวจสอบถ้าจำนวนเศษรวมกันได้ครบ 1 หน้า ให้เอาไป + global_page + tmp_new_page
    if(parseInt(tmp_new_page) >= 1){
      console.log('เคสที่ 1');
      console.log('global_page + tmp_new_page : ' + global_page + ' + (' + tmp_new_page + ') = ' + parseInt(global_page+tmp_new_page));
      console.log('เศษข้อความ = ' + tmp_new_offset);
    }else if(parseInt(tmp_new_page) == 0){ //ถ้าเศษข้อความรวมกันไม่ถึง 1 หน้า
      console.log('เคสที่ 2');
      console.log('global_page + tmp_new_page : ' + global_page + ' + (' + tmp_new_page + ') = ' + parseInt(global_page+tmp_new_page));
      console.log('เศษข้อความ = ' + tmp_new_offset);
    }

    //2.ตั้งค่า Page ใหม่ให้กับ link
    global_page = parseInt(global_page+tmp_new_page);
    global_offset = parseInt(tmp_new_offset);
    $("#load_old_message").attr("role", global_page);
    console.log(' set link page alt = ' + global_page);
    console.log(' set global offset = ' + global_offset);
  }

  function recieve_chat_store() {
    var recieve_chat_store = socket.subscribe('recieve_chat_store');
    recieve_chat_store.watch(function(data){
      console.log(data);
      //render
      for(i=0; i<=data.length-1; i++){
        if(data[i].user == $("#user").text().trim()){
          if(data[i].send_form == $("#store").text().trim()){
            $("#show_msg").append('<div class="row"><div class="left-msg">' + data[i].store + ' พิมพ์ว่า : ' + data[i].message + '</div></div>');
          }else{
            $("#show_msg").append('<div class="row"><div class="right-msg">' + data[i].user + ' พิมพ์ว่า : ' + data[i].message + '</div></div>');
          }
        }
        global_receive_new_message += 1;
        console.log('>>> recieve new message : '+ global_receive_new_message);
        set_link_load_old_message();
      }
      $(".show_msg").animate({scrollTop: 9999}, 400);
    });
  }

  function init_load_message() {
    $(".layout-loading").css('display','block');
    $(".show_msg").css('background-color','#F8F8FF');
    $("#txt_msg").prop( "disabled", false );
    $("#btn_send").prop( "disabled", false );

    //1. check & generate room_id
    $.ajax({
      method: "GET",
      url: "http://localhost:3000/api/validate_generate_room/" + $("#store").text().trim()  + "/" + $("#user").text().trim(),
    })
    .done(function( data ) {
      console.log('room_id : ' + data.room_id.$oid);
      $("#txt_room_id").val(data.room_id.$oid);
      $(".layout-loading").css('display','none');
      $(".show_msg").css('background-color','white');
    });

    //2. load old message
    $.ajax({
      method: "GET",
      url: "http://localhost:3000/api/get_load_message/" + $("#store").text().trim()  + "/" + $("#user").text().trim(),
    })
    .done(function( data ) {
      console.log(data);
      global_store = $("#store").text().trim();
      global_user = $("#user").text().trim();

      $("#show_msg").append('<div class="row" style="text-align: center; background-color: lightcyan;">' +
          '                  <a id="load_old_message" alt="api/get_load_message_by_page/' + global_store + '/' + global_user + '/" role="2" onclick="load_old_message()">โหลดบทสนทนาเก่า</a></div>');
      for(i=0; i<data.length; i++){
        //render
        if(data[i].user == $("#user").text().trim()){
          if(data[i].send_form == $("#store").text().trim()){
            $("#show_msg").append('<div class="row"><div class="left-msg">' + data[i].store + ' พิมพ์ว่า : ' + data[i].message + '</div></div>');
          }else{
            $("#show_msg").append('<div class="row"><div class="right-msg">' + data[i].user + ' พิมพ์ว่า : ' + data[i].message + '</div></div>');
          }
        }
      }
      $(".layout-loading").css('display','none');
      $(".show_msg").css('background-color','white');
      $(".show_msg").animate({
        scrollTop: 9999
      }, 400);
    });
  }

  function send_msg_to_store(){
      var data = {
        user: $("#user").text().trim(),
        store: $("#store").text().trim(),
        message: $("#txt_msg").val(),
        send_form: $("#user").text().trim(),
        room_id: $("#txt_room_id").val().trim()
      };
      socket.emit('chat_store', data);

    $("#txt_msg").val("");
  }

  window.addEventListener('popstate', function(event) {
    if (event.state) {
      socket.disconnect();
      location.reload();
    }
  }, false);



  $(document).ready(function(){
    recieve_chat_store();

    socket.on('connect', function(socket){
      console.log(socket);
      console.log('connect id : '+ socket.id);
      init_load_message();
    });

    socket.on('error', function(){
      $(".layout-loading").css('display','block');
      $(".show_msg").css('background-color','#F8F8FF');
      $("#txt_msg").prop( "disabled", true );
      $("#btn_send").prop( "disabled", true );
      console.log('error');
//      socket.connect();
    });

    $('#btn_send').click(function(e){
      send_msg_to_store();
    });


  });

  function load_old_message() {
    obj_link = document.getElementById("load_old_message");
    var url = $(obj_link).attr("alt");
    global_page = $(obj_link).attr("role");

    console.log(global_store + ' : ' + global_user);
    $.ajax({
      method: "GET",
      url: "http://localhost:3000/"+ url + global_page + '/' + global_offset,
    })
    .done(function( data ) {
      console.log(data);
      obj_link = document.getElementById("load_old_message");
//      $(obj_link).replaceWith('<div class="row" style="text-align: center;"><a id="load_old_message" alt="api/get_load_message_by_page/store01/test01/" role="' + parseInt(parseInt(global_page)+1) + '" onclick="load_old_message()">โหลดบทสนทนาเก่า</a></div>');
      $(obj_link).replaceWith('');
      if(data.length > 0){
        for(i=0;i<=data.length-1;i++){
          if(data[i].send_form == $("#store").text().trim()){
            $("#show_msg").prepend('<div class="row"><div class="left-msg">' + data[i].store + ' พิมพ์ว่า : ' + data[i].message + '</div></div>');
          }else{
            $("#show_msg").prepend('<div class="row"><div class="right-msg">' + data[i].user + ' พิมพ์ว่า : ' + data[i].message + '</div></div>');
          }
        }
        $("#show_msg").prepend('<div class="row" style="text-align: center; background-color: lightcyan;">' +
            '                   <a id="load_old_message" alt="api/get_load_message_by_page/' + global_store + '/' + global_user +'/" role="' + parseInt(parseInt(global_page)+1) + '" onclick="load_old_message()">โหลดบทสนทนาเก่า</a></div>');
      }
    });


  }
</script>