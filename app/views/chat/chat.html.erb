<%= javascript_include_tag "jquery.js" %>
<%= javascript_include_tag "bootstrap.js" %>
<%= javascript_include_tag "socketcluster.js" %>
<%= stylesheet_link_tag "bootstrap.css" %>

<style>
 .show_msg{
   min-height: 400px;
   border: gainsboro thin solid;
 }

 .right-msg {
   float: right;
   border: gainsboro thin solid;
   line-height: 30px;
   margin: 5px;
   padding: 5px;
 }

 .left-msg {
   float: left;
   border: gainsboro thin solid;
   line-height: 30px;
   margin: 5px;
   padding: 5px;
 }

</style>

<div class="container">
  <h1> [ คุณ <a id="user"><%= @user.name %></a> : คุยกับร้าน <a id="store"><%= @store.name %> </a>] </h1>
  <hr>
  <div class="row" style="margin-bottom: 5px;">
    <div id="show_msg" class="show_msg col-xs-12">

    </div>
  </div>
  <div class="row">
    <input type="text" id="txt_msg" class="col-xs-9">
    <input type="button" id="btn_send" value=" Send Message " class="col-xs-3">
  </div>
</div>



<script>
  var socket = socketCluster.connect({
    host:'localhost',
    port: 3333
  });

  function recieve_chat_store() {
    var recieve_chat_store = socket.subscribe('recieve_chat_store');
    recieve_chat_store.watch(function(data){
      console.log(data);
      //render
      if(data.user == $("#user").text().trim()){
        if(data.send_form == $("#store").text().trim()){
          $("#show_msg").append('<div class="row"><div class="left-msg">' + data.store + ' พิมพ์ว่า : ' + data.message + '</div></div>');
        }else{
          $("#show_msg").append('<div class="row"><div class="right-msg">' + data.user + ' พิมพ์ว่า : ' + data.message + '</div></div>');
        }
      }
    });
  }

  function send_msg_to_store(){
    var data = {
      user: $("#user").text().trim(),
      store: $("#store").text().trim(),
      message: $("#txt_msg").val(),
      send_form: $("#user").text().trim()
    }
    socket.emit('chat_store', data);
    $("#txt_msg").val("");

  }

  $(document).ready(function(){
    recieve_chat_store();

    $('#btn_send').click(function(e){
      send_msg_to_store();
    });

//    window.addEventListener('popstate', function(event) {
//      if (event.state) {
////
//        socket.unsubscribe('recieve_chat_store');
//        console.log(socket);
//        socket.disconnect();
//        console.log(socket);
//      }
//    }, false);

  });

  window.addEventListener('popstate', function(event) {
        if (event.state) {
          socket.disconnect();
          location.reload();
        }
  }, false);


</script>